<html>

<head>

<style>


table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-family: Arial, sans-serif;
    font-size: 14px;
}

th, td {
    padding: 10px;
    text-align: left;
    border: 1px solid #ddd;
}

th {
    background-color: #3498db;
    color: white;
    text-transform: uppercase;
}

tr:nth-child(even) {
    background-color: #f9f9f9;
}

tr:hover {
    background-color: #f1f1f1;
}



    body{
        margin:0;
       
    }
    .main{
        margin:5px;
      
        background-color: 	#eae7e7;
        width: 100%;
        height:100%;
        margin:0;
        padding:0;
        border:none;
        display: flex;
        flex-direction: column; 
        justify-content: center;
        align-items: center;
        
    }

    .round{

        border-radius: 25px;
    }


    .history{
        padding:20px;
        background-color: white;
        width:80%;
        height:70%;
        overflow-y: auto;
        display: flex;
        flex-direction: column; 
        align-items: start;
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
    }
    .inputBox{
        background-color:rgb(201, 198, 198);
        margin:10px;
        display: flex;
        align-items: center;
        padding:5px 10px;
        
    }
    .inputBox input{
        padding:10px;
        height:4vh;
        width:50vw;
        border:none;
        font-size: 1.1em;
        background-color: transparent;
        
    }
    #promptBtn{

        padding:none;
        border:none;
        height:40px
    }
    .chat{
        float: left;;
        font-size:20px;
        padding:10px;
        background-color:#e3e3e3;
        
        border-radius: 25px;
        word-wrap: break-word;
        width:auto;

    }

    .chat.sent {
    align-self: flex-end;
    
    }

.message.received {
    align-self: flex-start;
    background-color: hsl(0, 0%, 89%);
    }

    form{margin: 0;}
    
    #promptInput:focus{
    outline: none;
    border: none;
    }


    .logo{
        align-self: flex-start;
        margin:5px 10%;
        font-size: 2.5em;

    }

    .chatblock{
        border-radius: 0;
        max-width:80%;
        height: 50%;
        overflow-x: auto;

    }
    .chatblock {
    overflow-x: auto;
    max-width: 100%;
    padding: 5px;
}


</style>

</head>


<body>

<div class="main">
    <p class="logo">Data Analysis Ai</p>
    <div class="history round" id="history"></div>
    
    <div class="inputBox round">
        <form id="promptForm" onsubmit=sendPrompt(event)>
        <input id="promptInput" placeholder="Enter a prompt here" >
        <button id="promptBtn"  onclick=sendPrompt()  type='submit' class="round">send</button>
    </form>
    
    </div>

</div>


<script>
  historybox=document.getElementById('history')
  inp=document.getElementById('promptInput')
  inputform=document.getElementById('promptForm')
  storedTables=[]
  inp.focus()

  function sendPrompt(){
    if(event){
        event.preventDefault();
    }
    inputform.disabled=true
    

    
    inputdata=inp.value
    if (inputdata==''){return}
    inp.value=''
    entered_prompt=document.createElement('p');
    entered_prompt.textContent=inputdata;
    entered_prompt.className='chat sent';
    wait_message=document.createElement('p')
    wait_message.textContent='Waiting for response... '
    wait_message.className='chat received'
    historybox.appendChild(entered_prompt)
    historybox.appendChild(wait_message)
    historybox.scrollTop=historybox.scrollHeight;
    let url='/sendPrompt'
    let data={prompt:inputdata}

    fetch(url,{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data),

    }).then(response=>response.json())
    .then((response)=>{
        handleResponse(response);
    }).catch((err)=>{
        console.log(err);
    });


}


function handleResponse(response){
    inputform.disabled=false;
    historybox.removeChild(historybox.lastChild)
    responseHasTable=response.messages.some((res)=>res.type=='table')
    let currentTableIndex=storedTables.length


    for (let message of response.messages){
        console.log(message)
        if (message.type=='text'){
            resp=document.createElement('p');
            resp.className='chat received'
            resp.textContent=message.data;
            if(responseHasTable){
                attachment=document.createElement('button');
                attachment.textContent='Attached Table';
                attachment.className='attachment';
                attachment.tableIndex=currentTableIndex
                attachment.onclick=function (){
                    console.log(this)
                    displayTable(storedTables[this.tableIndex])
                }
                resp.appendChild(attachment)

            }        
            historybox.appendChild(resp)
        }
        else if (message.type=='table'){
            storedTables.push(message.data)
            console.log('all tables',storedTables)
            displayTable(message.data)
        }   

    }
}


function displayTable(tableData){

    table=document.createElement('table');
    table.className='chat received'
    firstrow=document.createElement('tr')

    for (let column of tableData.columns){

        th=document.createElement('th')
        th.innerHTML=column
        firstrow.appendChild(th)

    }
    table.appendChild(firstrow)

    for(let rows of tableData.rows){
        tr=document.createElement('tr')
        for (let cell_data of rows){
            td=document.createElement('td')
            td.innerHTML=cell_data
            tr.appendChild(td)
        }
        table.appendChild(tr)

        
    }
    chatblock=document.createElement('div');
    chatblock.className='chat received chatblock';
    chatblock.appendChild(table)
    historybox.appendChild(chatblock)

}




</script>


</body>

</html>